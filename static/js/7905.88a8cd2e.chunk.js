"use strict";(self.webpackChunkpublish=self.webpackChunkpublish||[]).push([[7905],{77905:(o,e,n)=>{n.d(e,{GN:()=>E});var t=n(30574),a=n(76844),r=n(268),s=n(80883),i=n(59979),c=n(86609),d=n(60205),l=n(84657),u=n(24657),T=n(13801);const k={getGasPriceInEther:(o,e)=>Number(e*o)/1e18,getGasPriceInUSD(o,e,n){const t=k.getGasPriceInEther(e,n);return r.S.bigNumber(o).times(t).toNumber()},getPriceImpact(o){let{sourceTokenAmount:e,sourceTokenPriceInUSD:n,toTokenPriceInUSD:t,toTokenAmount:a}=o;const s=r.S.bigNumber(e).times(n),i=r.S.bigNumber(a).times(t);return s.minus(i).div(s).times(100).toNumber()},getMaxSlippage(o,e){const n=r.S.bigNumber(o).div(100);return r.S.multiply(e,n).toNumber()},getProviderFee(o){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.0085;return r.S.bigNumber(o).times(e).toString()},isInsufficientNetworkTokenForGas(o,e){const n=e||"0";return!!r.S.bigNumber(o).eq(0)||r.S.bigNumber(r.S.bigNumber(n)).gt(o)},isInsufficientSourceTokenForSwap(o,e,n){var t;const a=null===n||void 0===n||null===(t=n.find((o=>o.address===e)))||void 0===t||null===(t=t.quantity)||void 0===t?void 0:t.numeric;return r.S.bigNumber(a||"0").lt(o)}};var v=n(68882),m=n(595),p=n(63542),g=n(65618),w=n(17321),A=n(23743),S=n(25015),P=n(79323),I=n(61139),f=n(7258);const b=15e4;Error;const h={initializing:!1,initialized:!1,loadingPrices:!1,loadingQuote:!1,loadingApprovalTransaction:!1,loadingBuildTransaction:!1,loadingTransaction:!1,fetchError:!1,approvalTransaction:void 0,swapTransaction:void 0,transactionError:void 0,sourceToken:void 0,sourceTokenAmount:"",sourceTokenPriceInUSD:0,toToken:void 0,toTokenAmount:"",toTokenPriceInUSD:0,networkPrice:"0",networkBalanceInUSD:"0",networkTokenSymbol:"",inputError:void 0,slippage:l.oU.CONVERT_SLIPPAGE_TOLERANCE,tokens:void 0,popularTokens:void 0,suggestedTokens:void 0,foundTokens:void 0,myTokensWithBalance:void 0,tokensPriceMap:{},gasFee:"0",gasPriceInUSD:0,priceImpact:void 0,maxSlippage:void 0,providerFee:void 0},y=(0,t.BX)({...h}),N={state:y,subscribe:o=>(0,t.B1)(y,(()=>o(y))),subscribeKey:(o,e)=>(0,a.u$)(y,o,e),getParams(){var o,e,n,t,a,i,c,l,T;const k=w.W.state.activeChain,v=null!==(o=m.U.getCaipAddress(k))&&void 0!==o?o:w.W.state.activeCaipAddress,p=u.w.getPlainAddress(v),g=(0,d.K1)(),A=S.a.getConnectorId(w.W.state.activeChain);if(!p)throw new Error("No address found to swap the tokens from.");const P=!(null!==(e=y.toToken)&&void 0!==e&&e.address)||!(null!==(n=y.toToken)&&void 0!==n&&n.decimals),I=!(null!==(t=y.sourceToken)&&void 0!==t&&t.address)||!(null!==(a=y.sourceToken)&&void 0!==a&&a.decimals)||!r.S.bigNumber(y.sourceTokenAmount).gt(0),f=!y.sourceTokenAmount;return{networkAddress:g,fromAddress:p,fromCaipAddress:v,sourceTokenAddress:null===(i=y.sourceToken)||void 0===i?void 0:i.address,toTokenAddress:null===(c=y.toToken)||void 0===c?void 0:c.address,toTokenAmount:y.toTokenAmount,toTokenDecimals:null===(l=y.toToken)||void 0===l?void 0:l.decimals,sourceTokenAmount:y.sourceTokenAmount,sourceTokenDecimals:null===(T=y.sourceToken)||void 0===T?void 0:T.decimals,invalidToToken:P,invalidSourceToken:I,invalidSourceTokenAmount:f,availableToSwap:v&&!P&&!I&&!f,isAuthConnector:A===s.o.CONNECTOR_ID.AUTH}},setSourceToken(o){if(!o)return y.sourceToken=o,y.sourceTokenAmount="",void(y.sourceTokenPriceInUSD=0);y.sourceToken=o,E.setTokenPrice(o.address,"sourceToken")},setSourceTokenAmount(o){y.sourceTokenAmount=o},setToToken(o){if(!o)return y.toToken=o,y.toTokenAmount="",void(y.toTokenPriceInUSD=0);y.toToken=o,E.setTokenPrice(o.address,"toToken")},setToTokenAmount(o){y.toTokenAmount=o?r.S.toFixed(o,6):""},async setTokenPrice(o,e){let n=y.tokensPriceMap[o]||0;n||(y.loadingPrices=!0,n=await E.getAddressPrice(o)),"sourceToken"===e?y.sourceTokenPriceInUSD=n:"toToken"===e&&(y.toTokenPriceInUSD=n),y.loadingPrices&&(y.loadingPrices=!1),E.getParams().availableToSwap&&E.swapTokens()},switchTokens(){if(y.initializing||!y.initialized)return;const o=y.toToken?{...y.toToken}:void 0,e=y.sourceToken?{...y.sourceToken}:void 0,n=o&&""===y.toTokenAmount?"1":y.toTokenAmount;E.setSourceToken(o),E.setToToken(e),E.setSourceTokenAmount(n),E.setToTokenAmount(""),E.swapTokens()},resetState(){y.myTokensWithBalance=h.myTokensWithBalance,y.tokensPriceMap=h.tokensPriceMap,y.initialized=h.initialized,y.initializing=h.initializing,y.sourceToken=h.sourceToken,y.sourceTokenAmount=h.sourceTokenAmount,y.sourceTokenPriceInUSD=h.sourceTokenPriceInUSD,y.toToken=h.toToken,y.toTokenAmount=h.toTokenAmount,y.toTokenPriceInUSD=h.toTokenPriceInUSD,y.networkPrice=h.networkPrice,y.networkTokenSymbol=h.networkTokenSymbol,y.networkBalanceInUSD=h.networkBalanceInUSD,y.inputError=h.inputError},resetValues(){var o;const{networkAddress:e}=E.getParams(),n=null===(o=y.tokens)||void 0===o?void 0:o.find((o=>o.address===e));E.setSourceToken(n),E.setToToken(void 0)},getApprovalLoadingState:()=>y.loadingApprovalTransaction,clearError(){y.transactionError=void 0},async initializeState(){if(!y.initializing){if(y.initializing=!0,!y.initialized)try{await E.fetchTokens(),y.initialized=!0}catch(o){y.initialized=!1,f.P.showError("Failed to initialize swap"),I.I.goBack()}y.initializing=!1}},async fetchTokens(){var o;const{networkAddress:e}=E.getParams();await E.getNetworkTokenPrice(),await E.getMyTokensWithBalance();const n=null===(o=y.myTokensWithBalance)||void 0===o?void 0:o.find((o=>o.address===e));n&&(y.networkTokenSymbol=n.symbol,E.setSourceToken(n),E.setSourceTokenAmount("0"))},async getTokenList(){var o;const e=null===(o=w.W.state.activeCaipNetwork)||void 0===o?void 0:o.caipNetworkId;if(y.caipNetworkId!==e||!y.tokens)try{y.tokensLoading=!0;const o=await T.s.getTokenList(e);y.tokens=o,y.caipNetworkId=e,y.popularTokens=o.sort(((o,e)=>o.symbol<e.symbol?-1:o.symbol>e.symbol?1:0)),y.suggestedTokens=o.filter((o=>!!l.oU.SWAP_SUGGESTED_TOKENS.includes(o.symbol)))}catch(n){y.tokens=[],y.popularTokens=[],y.suggestedTokens=[]}finally{y.tokensLoading=!1}},async getAddressPrice(o){var e,n;const t=y.tokensPriceMap[o];if(t)return t;const a=await g.T.fetchTokenPrice({addresses:[o]}),r=(null===a||void 0===a?void 0:a.fungibles)||[],s=[...y.tokens||[],...y.myTokensWithBalance||[]],i=null===s||void 0===s||null===(e=s.find((e=>e.address===o)))||void 0===e?void 0:e.symbol,c=(null===(n=r.find((o=>o.symbol.toLowerCase()===(null===i||void 0===i?void 0:i.toLowerCase()))))||void 0===n?void 0:n.price)||0,d=parseFloat(c.toString());return y.tokensPriceMap[o]=d,d},async getNetworkTokenPrice(){var o;const{networkAddress:e}=E.getParams(),n=null===(o=(await g.T.fetchTokenPrice({addresses:[e]}).catch((()=>(f.P.showError("Failed to fetch network token price"),{fungibles:[]})))).fungibles)||void 0===o?void 0:o[0],t=(null===n||void 0===n?void 0:n.price.toString())||"0";y.tokensPriceMap[e]=parseFloat(t),y.networkTokenSymbol=(null===n||void 0===n?void 0:n.symbol)||"",y.networkPrice=t},async getMyTokensWithBalance(o){const e=await c.Z.getMyTokensWithBalance(o),n=T.s.mapBalancesToSwapTokens(e);n&&(await E.getInitialGasPrice(),E.setBalances(n))},setBalances(o){const{networkAddress:e}=E.getParams(),n=w.W.state.activeCaipNetwork;if(!n)return;const t=o.find((o=>o.address===e));o.forEach((o=>{y.tokensPriceMap[o.address]=o.price||0})),y.myTokensWithBalance=o.filter((o=>o.address.startsWith(n.caipNetworkId))),y.networkBalanceInUSD=t?r.S.multiply(t.quantity.numeric,t.price).toString():"0"},async getInitialGasPrice(){var o,e,n;const t=await T.s.fetchGasPrice();if(!t)return{gasPrice:null,gasPriceInUSD:null};switch(null===(o=w.W.state)||void 0===o||null===(o=o.activeCaipNetwork)||void 0===o?void 0:o.chainNamespace){case s.o.CHAIN.SOLANA:return y.gasFee=null!==(e=t.standard)&&void 0!==e?e:"0",y.gasPriceInUSD=r.S.multiply(t.standard,y.networkPrice).div(1e9).toNumber(),{gasPrice:BigInt(y.gasFee),gasPriceInUSD:Number(y.gasPriceInUSD)};case s.o.CHAIN.EVM:default:const o=null!==(n=t.standard)&&void 0!==n?n:"0",a=BigInt(o),i=BigInt(b),c=k.getGasPriceInUSD(y.networkPrice,i,a);return y.gasFee=o,y.gasPriceInUSD=c,{gasPrice:a,gasPriceInUSD:c}}},async swapTokens(){const o=m.U.state.address,e=y.sourceToken,n=y.toToken,t=r.S.bigNumber(y.sourceTokenAmount).gt(0);if(t||E.setToTokenAmount(""),!n||!e||y.loadingPrices||!t)return;y.loadingQuote=!0;const a=r.S.bigNumber(y.sourceTokenAmount).times(10**e.decimals).round(0);try{var s;const t=await g.T.fetchSwapQuote({userAddress:o,from:e.address,to:n.address,gasPrice:y.gasFee,amount:a.toString()});y.loadingQuote=!1;const i=null===t||void 0===t||null===(s=t.quotes)||void 0===s||null===(s=s[0])||void 0===s?void 0:s.toAmount;if(!i)return void p.h.open({displayMessage:"Incorrect amount",debugMessage:"Please enter a valid amount"},"error");const c=r.S.bigNumber(i).div(10**n.decimals).toString();E.setToTokenAmount(c);E.hasInsufficientToken(y.sourceTokenAmount,e.address)?y.inputError="Insufficient balance":(y.inputError=void 0,E.setTransactionDetails())}catch(i){const o=await T.s.handleSwapError(i);y.loadingQuote=!1,y.inputError=o||"Insufficient balance"}},async getTransaction(){const{fromCaipAddress:o,availableToSwap:e}=E.getParams(),n=y.sourceToken,t=y.toToken;if(o&&e&&n&&t&&!y.loadingQuote)try{y.loadingBuildTransaction=!0;let e;return e=await T.s.fetchSwapAllowance({userAddress:o,tokenAddress:n.address,sourceTokenAmount:y.sourceTokenAmount,sourceTokenDecimals:n.decimals})?await E.createSwapTransaction():await E.createAllowanceTransaction(),y.loadingBuildTransaction=!1,y.fetchError=!1,e}catch(a){return I.I.goBack(),f.P.showError("Failed to check allowance"),y.loadingBuildTransaction=!1,y.approvalTransaction=void 0,y.swapTransaction=void 0,void(y.fetchError=!0)}},async createAllowanceTransaction(){const{fromCaipAddress:o,sourceTokenAddress:e,toTokenAddress:n}=E.getParams();if(o&&n){if(!e)throw new Error("createAllowanceTransaction - No source token address found.");try{const t=await g.T.generateApproveCalldata({from:e,to:n,userAddress:o}),a=u.w.getPlainAddress(t.tx.from);if(!a)throw new Error("SwapController:createAllowanceTransaction - address is required");const r={data:t.tx.data,to:a,gasPrice:BigInt(t.tx.eip155.gasPrice),value:BigInt(t.tx.value),toAmount:y.toTokenAmount};return y.swapTransaction=void 0,y.approvalTransaction={data:r.data,to:r.to,gasPrice:r.gasPrice,value:r.value,toAmount:r.toAmount},{data:r.data,to:r.to,gasPrice:r.gasPrice,value:r.value,toAmount:r.toAmount}}catch(t){return I.I.goBack(),f.P.showError("Failed to create approval transaction"),y.approvalTransaction=void 0,y.swapTransaction=void 0,void(y.fetchError=!0)}}},async createSwapTransaction(){var o;const{networkAddress:e,fromCaipAddress:n,sourceTokenAmount:t}=E.getParams(),a=y.sourceToken,r=y.toToken;if(!n||!t||!a||!r)return;const s=null===(o=A.x.parseUnits(t,a.decimals))||void 0===o?void 0:o.toString();try{const o=await g.T.generateSwapCalldata({userAddress:n,from:a.address,to:r.address,amount:s,disableEstimate:!0}),t=a.address===e,i=BigInt(o.tx.eip155.gas),c=BigInt(o.tx.eip155.gasPrice),d=u.w.getPlainAddress(o.tx.to);if(!d)throw new Error("SwapController:createSwapTransaction - address is required");const l={data:o.tx.data,to:d,gas:i,gasPrice:c,value:t?BigInt(null!==s&&void 0!==s?s:"0"):BigInt("0"),toAmount:y.toTokenAmount};return y.gasPriceInUSD=k.getGasPriceInUSD(y.networkPrice,i,c),y.approvalTransaction=void 0,y.swapTransaction=l,l}catch(i){return I.I.goBack(),f.P.showError("Failed to create transaction"),y.approvalTransaction=void 0,y.swapTransaction=void 0,void(y.fetchError=!0)}},onEmbeddedWalletApprovalSuccess(){f.P.showLoading("Approve limit increase in your wallet"),I.I.replace("SwapPreview")},async sendTransactionForApproval(o){const{fromAddress:e,isAuthConnector:n}=E.getParams();y.loadingApprovalTransaction=!0;n?I.I.pushTransactionStack({onSuccess:E.onEmbeddedWalletApprovalSuccess}):f.P.showLoading("Approve limit increase in your wallet");try{await A.x.sendTransaction({address:e,to:o.to,data:o.data,value:o.value,chainNamespace:s.o.CHAIN.EVM}),await E.swapTokens(),await E.getTransaction(),y.approvalTransaction=void 0,y.loadingApprovalTransaction=!1}catch(c){var t,a,r;const o=c;y.transactionError=null===o||void 0===o?void 0:o.displayMessage,y.loadingApprovalTransaction=!1,f.P.showError((null===o||void 0===o?void 0:o.displayMessage)||"Transaction error"),P.E.sendEvent({type:"track",event:"SWAP_APPROVAL_ERROR",properties:{message:(null===o||void 0===o?void 0:o.displayMessage)||(null===o||void 0===o?void 0:o.message)||"Unknown",network:(null===(t=w.W.state.activeCaipNetwork)||void 0===t?void 0:t.caipNetworkId)||"",swapFromToken:(null===(a=E.state.sourceToken)||void 0===a?void 0:a.symbol)||"",swapToToken:(null===(r=E.state.toToken)||void 0===r?void 0:r.symbol)||"",swapFromAmount:E.state.sourceTokenAmount||"",swapToAmount:E.state.toTokenAmount||"",isSmartAccount:(0,d.lj)(s.o.CHAIN.EVM)===i.Vl.ACCOUNT_TYPES.SMART_ACCOUNT}})}},async sendTransactionForSwap(o){var e,n,t,a;if(!o)return;const{fromAddress:c,toTokenAmount:l,isAuthConnector:u}=E.getParams();y.loadingTransaction=!0;const T="Swapping ".concat(null===(e=y.sourceToken)||void 0===e?void 0:e.symbol," to ").concat(r.S.formatNumberToLocalString(l,3)," ").concat(null===(n=y.toToken)||void 0===n?void 0:n.symbol),k="Swapped ".concat(null===(t=y.sourceToken)||void 0===t?void 0:t.symbol," to ").concat(r.S.formatNumberToLocalString(l,3)," ").concat(null===(a=y.toToken)||void 0===a?void 0:a.symbol);u?I.I.pushTransactionStack({onSuccess(){I.I.replace("Account"),f.P.showLoading(T),N.resetState()}}):f.P.showLoading("Confirm transaction in your wallet");try{var v,m,p,g,S;const e=[null===(v=y.sourceToken)||void 0===v?void 0:v.address,null===(m=y.toToken)||void 0===m?void 0:m.address].join(","),n=await A.x.sendTransaction({address:c,to:o.to,data:o.data,value:o.value,chainNamespace:s.o.CHAIN.EVM});return y.loadingTransaction=!1,f.P.showSuccess(k),P.E.sendEvent({type:"track",event:"SWAP_SUCCESS",properties:{network:(null===(p=w.W.state.activeCaipNetwork)||void 0===p?void 0:p.caipNetworkId)||"",swapFromToken:(null===(g=E.state.sourceToken)||void 0===g?void 0:g.symbol)||"",swapToToken:(null===(S=E.state.toToken)||void 0===S?void 0:S.symbol)||"",swapFromAmount:E.state.sourceTokenAmount||"",swapToAmount:E.state.toTokenAmount||"",isSmartAccount:(0,d.lj)(s.o.CHAIN.EVM)===i.Vl.ACCOUNT_TYPES.SMART_ACCOUNT}}),N.resetState(),u||I.I.replace("Account"),N.getMyTokensWithBalance(e),n}catch(U){var b,h,C;const o=U;return y.transactionError=null===o||void 0===o?void 0:o.displayMessage,y.loadingTransaction=!1,f.P.showError((null===o||void 0===o?void 0:o.displayMessage)||"Transaction error"),void P.E.sendEvent({type:"track",event:"SWAP_ERROR",properties:{message:(null===o||void 0===o?void 0:o.displayMessage)||(null===o||void 0===o?void 0:o.message)||"Unknown",network:(null===(b=w.W.state.activeCaipNetwork)||void 0===b?void 0:b.caipNetworkId)||"",swapFromToken:(null===(h=E.state.sourceToken)||void 0===h?void 0:h.symbol)||"",swapToToken:(null===(C=E.state.toToken)||void 0===C?void 0:C.symbol)||"",swapFromAmount:E.state.sourceTokenAmount||"",swapToAmount:E.state.toTokenAmount||"",isSmartAccount:(0,d.lj)(s.o.CHAIN.EVM)===i.Vl.ACCOUNT_TYPES.SMART_ACCOUNT}})}},hasInsufficientToken:(o,e)=>k.isInsufficientSourceTokenForSwap(o,e,y.myTokensWithBalance),setTransactionDetails(){const{toTokenAddress:o,toTokenDecimals:e}=E.getParams();o&&e&&(y.gasPriceInUSD=k.getGasPriceInUSD(y.networkPrice,BigInt(y.gasFee),BigInt(b)),y.priceImpact=k.getPriceImpact({sourceTokenAmount:y.sourceTokenAmount,sourceTokenPriceInUSD:y.sourceTokenPriceInUSD,toTokenPriceInUSD:y.toTokenPriceInUSD,toTokenAmount:y.toTokenAmount}),y.maxSlippage=k.getMaxSlippage(y.slippage,y.toTokenAmount),y.providerFee=k.getProviderFee(y.sourceTokenAmount))}},E=(0,v.X)(N)}}]);
//# sourceMappingURL=7905.88a8cd2e.chunk.js.map